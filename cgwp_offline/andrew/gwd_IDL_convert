;
; Read in data from gwd_erai_0511_LMDz.txt
; 
uonp=[...]
zonp=[...]
;
; Read in data from MAI6NPANA.5.2.0_2005_11xUT
tonp=[...]
;
; Conversions to required inputs
qboll=[0.,5.,360.,-5]
R_gas=287.05
g_earth=9.80665
sqnmin = 1.0e-4
p_standard=100000.
p=p_standard/exp(zonp/7.)
;
nplevs=size(p,/N_elements)
nplevo=size(tonp,/N_elements)
pobs=100.*tonp.blev
pobs[nplevo-1]=p[nplevs-1]
;
tonpll=pp_extract(tonp,qboll)
pstar=pp_ff('(a*b)+c',tonpll[0],0.,100000.)
theta=t2theta(tonpll,pstar)
rhonp=pp_ff('b/(a*c)',tonpll[0],pobs[0],R_gas)
for k=1,nplevo-1 do rhonp=[rhonp,pp_ff('b/(a*c)',tonpll[k],pobs[k],R_gas)]
;
gmrho=interpol(pp_area_avg(rhonp,/box),pobs,p)
gmthe=interpol(pp_area_avg(theta,/box),pobs,p)
gmnbv=fltarr(nplevs)
for k=1,nplevs-2 do begin  & $
  gmnbv[k]=g_earth * (gmthe[k+1] - gmthe[k-1]) / $
                     (gmthe[k] * 1000. * (zonp[k+1] - zonp[k-1]))  & $
  gmnbv[k]=max([gmnbv[k], sqnmin])  & $
  gmnbv[k]=gmnbv[k]^0.5  & $
endfor
gmnbv[0]=gmnbv[1]
gmnbv[nplevs-1]=gmnbv[nplevs-2]
;
starrwriter,[1, 1, nplevs],'Dims'
starrwriter,uonp,'u'
starrwriter,replicate(0.0,nplevs),'v'
starrwriter,gmrho,'rho'
starrwriter,gmnbv,'nbv'
starrwriter,1000.*zonp,'z'
;
; Dims = [1,1,60]
; u = [-1.53603,-1.70576,-1.79461,-1.85700,-1.92230,-2.00456,-2.11919,-2.24962,-2.42923,-2.57863,-2.74274,-2.94430,-3.18480,-3.38261,-3.37309,-3.31417,-3.27580,-3.28126,-3.25058,-3.29692,-3.55807,-3.93855,-4.14086,-4.04535,-3.57705,-3.18238,-2.47336,-1.73698,-1.39811,-1.52065,-1.20460,-0.133617,0.234854,-0.659653,-1.55228,-3.10662,-2.95202,-3.90194,-11.8090,-21.8675,-30.1150,-34.9760,-32.7595,-19.7066,-2.57383,9.78729,15.4790,17.0613,15.9764,10.5762,2.88159,-1.21334,0.468062,6.60030,14.3249,14.0903,5.11119,-4.25064,-1.13366,2.95195]
; v = [0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000]
; rho = [1.16725,1.16473,1.16101,1.15575,1.14866,1.13903,1.12681,1.11122,1.09237,1.07006,1.04423,1.01595,0.986077,0.954503,0.921112,0.885814,0.848528,0.809575,0.768688,0.727456,0.686319,0.645568,0.604709,0.564604,0.525300,0.486919,0.450526,0.415547,0.381992,0.349604,0.318954,0.288275,0.259662,0.229835,0.201894,0.174829,0.145029,0.118520,0.0949697,0.0752669,0.0594443,0.0469053,0.0369925,0.0291832,0.0233207,0.0185887,0.0147770,0.0118311,0.00945098,0.00752667,0.00597352,0.00471407,0.00368190,0.00282463,0.00212039,0.00152787,0.00105592,0.000691052,0.000411557,0.000155538]
; nbv = [0.0100000,0.0100000,0.0100000,0.0100000,0.0100000,0.0100000,0.0113523,0.0133156,0.0145886,0.0157469,0.0160253,0.0151175,0.0139933,0.0133356,0.0131232,0.0133258,0.0136481,0.0142376,0.0143811,0.0137680,0.0130605,0.0127577,0.0124734,0.0119703,0.0116440,0.0105670,0.0100000,0.0100000,0.0100000,0.0100000,0.0100000,0.0100000,0.0104479,0.0124120,0.0141260,0.0196735,0.0223059,0.0231881,0.0236070,0.0234453,0.0234151,0.0239779,0.0238446,0.0238126,0.0225841,0.0197902,0.0206109,0.0218030,0.0215812,0.0220241,0.0226264,0.0227865,0.0219510,0.0228966,0.0220148,0.0196337,0.0184634,0.0178173,0.0171374,0.0171374]
; z = [0.00000,20.7241,51.3751,95.0276,154.285,231.350,328.075,446.059,586.650,751.063,940.347,1155.45,1397.26,1666.59,1964.23,2290.96,2647.49,3034.58,3452.94,3903.29,4386.34,4902.78,5453.31,6038.62,6659.43,7316.54,8010.92,8743.89,9517.37,10334.4,11200.0,12119.0,13094.9,14131.3,15231.8,16400.1,17639.9,18955.2,20345.4,21806.2,23306.2,24806.2,26306.2,27806.2,29306.2,30806.3,32306.2,33806.2,35306.2,36806.2,38314.8,39860.2,41483.6,43232.7,45167.4,47366.7,49942.0,53057.0,56962.6,64466.7]
;
; Read in offline flux
fptot=[...]
;
cosphi=[1,-1]
;
; Check location of launch level
mfptot0=fltarr(nplevs)
for k=0,nplevs-1 do mfptot0[k]=max(1000.*fptot[k,0])
llaunch=min(where(mfptot0 gt 0))
;
accgwphi=fltarr(nplevs,idir)
gwaccew=fltarr(nplevs)
;
for k=llaunch+1,nplevs-1 do begin  & $
  for jdir=0,idir-1 do begin  & $
    accgwphi[k,jdir] = g_earth*(fptot[k,jdir] - fptot[k-1,jdir])/(p[k] - p[k-1]) & $
    gwaccew[k]  = gwaccew[k] + (accgwphi[k,jdir] * cosphi[jdir])  & $
  endfor  & $
endfor
;
starrwriter,fspd*gwaccew,'EW accel'
starrwriter,1000.*fptot[0:nplevs-1,0],'Eastward flux'
starrwriter,1000.*fptot[0:nplevs-1,1],'Westward flux'
;
; EW accel = [0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,-0.000133390,-0.000675233,-0.000598760,0.00000,0.00000,2.83891e-05,0.00149995,0.00415802,0.00293935,0.00000,0.00221657,0.0171106,0.00818373,0.00000,0.00000,0.00000,0.00000,0.00000,-0.489784,-0.536312,-0.101485,-0.0331096,0.00000,0.00000,0.00000,3.10230,0.633073,0.123704,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,4.07287]
; Eastward flux = [0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,1.51440,1.51440,1.51440,1.51440,1.51440,1.51440,1.51428,1.50840,1.49287,1.48246,1.48246,1.47551,1.42535,1.40309,1.40309,1.40309,1.40309,1.40309,1.40309,1.40309,1.40309,1.40309,1.40309,1.40309,1.40309,1.40309,0.329711,0.152944,0.125063,0.125063,0.125063,0.125063,0.125063,0.125063,0.125063,0.125063,0.125063,0.125063,0.125063,0.125063,0.00000]
; Westward flux = [0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,0.00000,1.51440,1.51380,1.51077,1.50811,1.50811,1.50811,1.50811,1.50811,1.50811,1.50811,1.50811,1.50811,1.50811,1.50811,1.50811,1.50811,1.50811,1.50811,1.50811,0.813881,0.162138,0.0596289,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.0326352,0.00000]
;
